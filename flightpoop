-- ULTIMATE STEALTH FLIGHTNOCLIP with Mobile Controls
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")

local Player = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Configuration
local NoclipKey = Enum.KeyCode.N
local Speed = 25
local MaxSpeed = 150
local SpeedIncrement = 10
local isNoclipping = false
local isFlying = false
local MoveDirection = Vector3.new()
local CurrentSpeed = Speed
local TargetPlayer = Player

-- Detect if on mobile
local IS_MOBILE = UserInputService.TouchEnabled and not UserInputService.MouseEnabled and not UserInputService.KeyboardEnabled

-- STEALTH NOCLIP FUNCTION (INSTANT PHASE)
local function StealthNoclip()
    if not Player.Character then return end
    
    for _, part in pairs(Player.Character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = false
            part.Massless = true -- Makes parts have no physical presence
            part.Transparency = 0.3 -- Slight transparency for stealth
        end
    end
    
    -- Anti-tpback: Remove all velocity instantly
    local root = Player.Character:FindFirstChild("HumanoidRootPart")
    if root then
        root.Velocity = Vector3.new(0, 0, 0)
        root.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
    end
end

-- Main GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "StealthNoclipGui"
ScreenGui.Parent = CoreGui
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 250, 0, 100)
MainFrame.Position = UDim2.new(0.5, -125, 0, 10)
MainFrame.AnchorPoint = Vector2.new(0.5, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 40)
MainFrame.BackgroundTransparency = 0.1
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, 0, 0, 25)
TitleLabel.Position = UDim2.new(0, 0, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.TextColor3 = Color3.fromRGB(0, 255, 255)
TitleLabel.Text = "STEALTH FLIGHTNOCLIP"
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextSize = 16
TitleLabel.Parent = MainFrame

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, 0, 0, 25)
StatusLabel.Position = UDim2.new(0, 0, 0, 25)
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
StatusLabel.Text = "NOCLIP: OFF | FLIGHT: OFF"
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 14
StatusLabel.Parent = MainFrame

local SpeedLabel = Instance.new("TextLabel")
SpeedLabel.Size = UDim2.new(1, 0, 0, 20)
SpeedLabel.Position = UDim2.new(0, 0, 0, 50)
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.TextColor3 = Color3.fromRGB(200, 200, 255)
SpeedLabel.Text = "Speed: " .. Speed
SpeedLabel.Font = Enum.Font.Gotham
SpeedLabel.TextSize = 12
SpeedLabel.Parent = MainFrame

local ControlsLabel = Instance.new("TextLabel")
ControlsLabel.Size = UDim2.new(1, 0, 0, 20)
ControlsLabel.Position = UDim2.new(0, 0, 0, 70)
ControlsLabel.BackgroundTransparency = 1
ControlsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
ControlsLabel.Text = IS_MOBILE and "Use mobile controls" or "N: Noclip | WASD: Fly"
ControlsLabel.Font = Enum.Font.Gotham
ControlsLabel.TextSize = 11
ControlsLabel.Parent = MainFrame

-- Mobile Controls
local MobileGui = Instance.new("ScreenGui")
MobileGui.Name = "MobileStealthControls"
MobileGui.Parent = CoreGui
MobileGui.ResetOnSpawn = false
MobileGui.Enabled = IS_MOBILE

local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0, 120, 0, 50)
ToggleButton.Position = UDim2.new(0.5, -60, 0.9, -50)
ToggleButton.AnchorPoint = Vector2.new(0.5, 0)
ToggleButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
ToggleButton.BackgroundTransparency = 0.2
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Text = "STEALTH: OFF"
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.TextSize = 14
ToggleButton.Visible = IS_MOBILE
ToggleButton.Parent = MobileGui

local JoystickFrame = Instance.new("Frame")
JoystickFrame.Size = UDim2.new(0, 140, 0, 140)
JoystickFrame.Position = UDim2.new(0, 30, 0.7, -70)
JoystickFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 50)
JoystickFrame.BackgroundTransparency = 0.6
JoystickFrame.BorderSizePixel = 0
JoystickFrame.Visible = IS_MOBILE
JoystickFrame.Parent = MobileGui

local JoystickInner = Instance.new("Frame")
JoystickInner.Size = UDim2.new(0, 50, 0, 50)
JoystickInner.Position = UDim2.new(0.5, -25, 0.5, -25)
JoystickInner.AnchorPoint = Vector2.new(0.5, 0.5)
JoystickInner.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
JoystickInner.BackgroundTransparency = 0.2
JoystickInner.BorderSizePixel = 0
JoystickInner.Parent = JoystickFrame

local UpButton = Instance.new("TextButton")
UpButton.Size = UDim2.new(0, 70, 0, 70)
UpButton.Position = UDim2.new(0.8, -35, 0.6, -100)
UpButton.BackgroundColor3 = Color3.fromRGB(30, 30, 50)
UpButton.BackgroundTransparency = 0.6
UpButton.Text = "↑"
UpButton.TextColor3 = Color3.fromRGB(255, 255, 255)
UpButton.Font = Enum.Font.GothamBold
UpButton.TextSize = 24
UpButton.Visible = IS_MOBILE
UpButton.Parent = MobileGui

local DownButton = Instance.new("TextButton")
DownButton.Size = UDim2.new(0, 70, 0, 70)
DownButton.Position = UDim2.new(0.8, -35, 0.6, 0)
DownButton.BackgroundColor3 = Color3.fromRGB(30, 30, 50)
DownButton.BackgroundTransparency = 0.6
DownButton.Text = "↓"
DownButton.TextColor3 = Color3.fromRGB(255, 255, 255)
DownButton.Font = Enum.Font.GothamBold
DownButton.TextSize = 24
DownButton.Visible = IS_MOBILE
DownButton.Parent = MobileGui

-- Update GUI
local function UpdateGUI()
    StatusLabel.Text = "NOCLIP: " .. (isNoclipping and "ON" or "OFF") .. " | FLIGHT: " .. (isFlying and "ON" or "OFF")
    SpeedLabel.Text = "Speed: " .. CurrentSpeed
    
    if IS_MOBILE then
        ToggleButton.Text = "STEALTH: " .. (isNoclipping and "ON" or "OFF")
        ToggleButton.BackgroundColor3 = isNoclipping and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
    end
end

-- Mobile Controls
local joystickActive = false
JoystickFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        joystickActive = true
    end
end)

JoystickFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch and joystickActive then
        local delta = (Vector2.new(input.Position.X, input.Position.Y) - Vector2.new(JoystickFrame.AbsolutePosition.X + 70, JoystickFrame.AbsolutePosition.Y + 70)) / 50
        delta = Vector2.new(math.clamp(delta.X, -1, 1), math.clamp(delta.Y, -1, 1))
        MoveDirection = Vector3.new(delta.X, 0, delta.Y)
        JoystickInner.Position = UDim2.new(0.5, delta.X * 35, 0.5, delta.Y * 35)
        isFlying = true
    end
end)

JoystickFrame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        joystickActive = false
        MoveDirection = Vector3.new(0, 0, 0)
        JoystickInner.Position = UDim2.new(0.5, -25, 0.5, -25)
        isFlying = false
    end
end)

UpButton.MouseButton1Down:Connect(function() MoveDirection = Vector3.new(MoveDirection.X, 1, MoveDirection.Z) isFlying = true end)
UpButton.MouseButton1Up:Connect(function() MoveDirection = Vector3.new(MoveDirection.X, 0, MoveDirection.Z) end)
DownButton.MouseButton1Down:Connect(function() MoveDirection = Vector3.new(MoveDirection.X, -1, MoveDirection.Z) isFlying = true end)
DownButton.MouseButton1Up:Connect(function() MoveDirection = Vector3.new(MoveDirection.X, 0, MoveDirection.Z) end)

ToggleButton.MouseButton1Click:Connect(function()
    isNoclipping = not isNoclipping
    UpdateGUI()
end)

-- Keyboard Controls
UserInputService.InputBegan:Connect(function(input, processed)
    if processed or IS_MOBILE then return end
    
    if input.KeyCode == NoclipKey then
        isNoclipping = not isNoclipping
        UpdateGUI()
        return
    end
    
    if not isNoclipping then return end
    
    local key = input.KeyCode
    if key == Enum.KeyCode.W then MoveDirection = Vector3.new(MoveDirection.X, MoveDirection.Y, -1) isFlying = true
    elseif key == Enum.KeyCode.S then MoveDirection = Vector3.new(MoveDirection.X, MoveDirection.Y, 1) isFlying = true
    elseif key == Enum.KeyCode.A then MoveDirection = Vector3.new(-1, MoveDirection.Y, MoveDirection.Z) isFlying = true
    elseif key == Enum.KeyCode.D then MoveDirection = Vector3.new(1, MoveDirection.Y, MoveDirection.Z) isFlying = true
    elseif key == Enum.KeyCode.Space then MoveDirection = Vector3.new(MoveDirection.X, 1, MoveDirection.Z) isFlying = true
    elseif key == Enum.KeyCode.LeftControl then MoveDirection = Vector3.new(MoveDirection.X, -1, MoveDirection.Z) isFlying = true
    end
end)

UserInputService.InputEnded:Connect(function(input, processed)
    if processed or not isNoclipping or IS_MOBILE then return end
    local key = input.KeyCode
    if key == Enum.KeyCode.W or key == Enum.KeyCode.S then MoveDirection = Vector3.new(MoveDirection.X, MoveDirection.Y, 0)
    elseif key == Enum.KeyCode.A or key == Enum.KeyCode.D then MoveDirection = Vector3.new(0, MoveDirection.Y, MoveDirection.Z)
    elseif key == Enum.KeyCode.Space or key == Enum.KeyCode.LeftControl then MoveDirection = Vector3.new(MoveDirection.X, 0, MoveDirection.Z)
    end
end)

-- INSTANT FLIGHT MOVEMENT (NO DELAY)
local function StealthFlight()
    if not isNoclipping or not Player.Character then return end
    local root = Player.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    StealthNoclip() -- Apply stealth noclip first
    
    if MoveDirection.Magnitude > 0 then
        local camCF = Camera.CFrame
        local moveVector = (camCF.LookVector * MoveDirection.Z + camCF.RightVector * MoveDirection.X + Vector3.new(0, MoveDirection.Y, 0)) * (CurrentSpeed * 0.03)
        root.CFrame = root.CFrame + moveVector
    end
end

-- Main stealth loop (INSTANT PHASE)
RunService.Stepped:Connect(function()
    if isNoclipping then
        StealthFlight()
    end
end)

UpdateGUI()
print("ULTIMATE STEALTH FLIGHTNOCLIP LOADED!")
print("Press N to toggle noclip | WASD to fly")
print("INSTANT PHASE - ANTI-ANTICHEAT ENABLED")
